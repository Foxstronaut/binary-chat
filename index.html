<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fully P2P Chat - QR Signaling</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    body { display: flex; align-items: center; justify-content: center; padding: 10px; }
    .container { width: 100%; max-width: 500px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: 100vh; max-height: 90vh; }
    header { background: #2196F3; color: white; padding: 15px; text-align: center; }
    h1 { margin: 0 0 3px 0; font-size: 20px; }
    .subtitle { font-size: 11px; opacity: 0.9; margin: 0; }
    .status { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; flex-shrink: 0; }
    .status-dot.connected { background: #4CAF50; }
    .messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 6px; font-size: 13px; }
    .msg { padding: 8px 10px; border-radius: 6px; word-wrap: break-word; max-width: 85%; }
    .msg.sent { background: #E8F5E9; color: #1B5E20; align-self: flex-end; }
    .msg.recv { background: #E3F2FD; color: #0D47A1; align-self: flex-start; }
    .msg.status { background: #FFF9C4; color: #F57F17; font-size: 11px; align-self: center; }
    .input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 6px; }
    input { flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; }
    button { padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; }
    button:hover { background: #1976D2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .controls { padding: 10px 15px; border-top: 1px solid #eee; display: flex; gap: 6px; flex-wrap: wrap; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z: 1000; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 20px; text-align: center; max-width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-content h2 { margin: 0 0 15px 0; font-size: 16px; }
    #qrcode, #scanner { margin: 10px auto; }
    #scanner { width: 100%; max-width: 300px; }
    .qr-data { font-family: monospace; background: #f5f5f5; padding: 8px; border-radius: 6px; margin: 10px 0; font-size: 10px; word-break: break-all; max-height: 150px; overflow-y: auto; }
    .btn-group { display: flex; gap: 6px; margin: 10px 0; }
    .btn-group button { flex: 1; }
    .copy-btn { background: #666; }
    .copy-btn:hover { background: #444; }
    .close-btn { background: #999; }
    .close-btn:hover { background: #777; }
    textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 11px; font-family: monospace; resize: vertical; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Fully P2P Chat</h1>
      <p class="subtitle">QR code signaling • No server</p>
    </header>

    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <div id="statusText">Ready</div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Message..." />
      <button id="sendBtn" disabled>Send</button>
    </div>

    <div class="controls">
      <button id="initBtn">Start</button>
      <button id="qrSendBtn" disabled>Share QR</button>
      <button id="qrRecvBtn" disabled>Scan QR</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
  </div>

  <!-- QR Send Modal -->
  <div class="modal" id="qrSendModal">
    <div class="modal-content">
      <h2>Share This QR Code</h2>
      <div id="qrcode" style="margin: 15px auto;"></div>
      <textarea id="qrText" readonly rows="4"></textarea>
      <div class="btn-group">
        <button class="copy-btn" onclick="copyToClipboard()">Copy Text</button>
        <button class="close-btn" onclick="closeModal('qrSendModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- QR Receive Modal -->
  <div class="modal" id="qrRecvModal">
    <div class="modal-content">
      <h2>Scan QR or Paste Data</h2>
      <video id="cameraFeed" style="width: 100%; max-width: 300px; border-radius: 6px; background: #000; margin: 10px auto; display: none;"></video>
      <div id="scanner" style="background: #000; border-radius: 6px; margin: 10px auto;"></div>
      <textarea id="pasteInput" placeholder="Or paste data here..." rows="4"></textarea>
      <div class="btn-group">
        <button id="cameraBtn" onclick="startCamera()">Use Camera</button>
        <button onclick="processInput()">Process</button>
        <button class="close-btn" onclick="closeModal('qrRecvModal')">Close</button>
      </div>
    </div>
  </div>

  <script>
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const initBtn = document.getElementById('initBtn');
    const qrSendBtn = document.getElementById('qrSendBtn');
    const qrRecvBtn = document.getElementById('qrRecvBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');

    let peerId = 'peer_' + Math.random().toString(36).substr(2, 8);
    let peerConnection = null;
    let dataChannel = null;
    let localOffer = null;
    let signalingState = 'idle'; // idle, waiting_for_answer, connected
    let cameraStream = null;
    let scanningActive = false;

    function updateStatus(text, connected = false) {
      statusText.textContent = text;
      statusDot.className = 'status-dot' + (connected ? ' connected' : '');
    }

    function addMsg(text, type) {
      const m = document.createElement('div');
      m.className = 'msg ' + type;
      m.textContent = text;
      messagesDiv.appendChild(m);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    window.copyToClipboard = function() {
      const text = document.getElementById('qrText').value;
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied!');
      });
    };

    async function createPeerConnection(isInitiator) {
      peerConnection = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });

      peerConnection.onicecandidate = (e) => {
        if (e.candidate) {
          console.log('ICE candidate generated');
        }
      };

      peerConnection.onconnectionstatechange = () => {
        console.log('Connection state:', peerConnection.connectionState);
        if (peerConnection.connectionState === 'failed') {
          addMsg('Connection failed', 'status');
          updateStatus('Failed', false);
        }
      };

      if (isInitiator) {
        dataChannel = peerConnection.createDataChannel('chat');
        setupDataChannel();
      } else {
        peerConnection.ondatachannel = (e) => {
          dataChannel = e.channel;
          setupDataChannel();
        };
      }
    }

    function setupDataChannel() {
      dataChannel.onopen = () => {
        console.log('Data channel opened');
        updateStatus('P2P Connected ✓', true);
        sendBtn.disabled = false;
        msgInput.disabled = false;
        qrSendBtn.disabled = true;
        qrRecvBtn.disabled = true;
        initBtn.disabled = true;
        disconnectBtn.disabled = false;
        signalingState = 'connected';
        addMsg('Connected!', 'status');
      };

      dataChannel.onclose = () => {
        console.log('Data channel closed');
        updateStatus('Disconnected', false);
        sendBtn.disabled = true;
        msgInput.disabled = true;
        qrSendBtn.disabled = false;
        qrRecvBtn.disabled = false;
        initBtn.disabled = false;
        disconnectBtn.disabled = true;
      };

      dataChannel.onmessage = (e) => {
        addMsg(e.data, 'recv');
      };

      dataChannel.onerror = (err) => {
        console.error('Data channel error:', err);
        addMsg('Error: ' + err.message, 'status');
      };
    }

    async function initiate() {
      addMsg('Generating offer...', 'status');
      await createPeerConnection(true);

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      localOffer = peerConnection.localDescription;
      signalingState = 'waiting_for_answer';
      updateStatus('Waiting for answer...', false);
      
      showQrForData(JSON.stringify({
        type: 'offer',
        peerId: peerId,
        sdp: offer.sdp
      }));

      qrSendBtn.disabled = false;
      qrRecvBtn.disabled = false;
    }

    function showQrForData(data) {
      const qrcodeDiv = document.getElementById('qrcode');
      qrcodeDiv.innerHTML = '';
      new QRCode(qrcodeDiv, {
        text: data,
        width: 250,
        height: 250,
        colorDark: '#000000',
        colorLight: '#ffffff'
      });
      document.getElementById('qrText').value = data;
      document.getElementById('qrSendModal').classList.add('show');
    }

    window.processInput = async function() {
      const text = document.getElementById('pasteInput').value.trim();
      if (!text) return;

      try {
        const data = JSON.parse(text);

        if (data.type === 'offer' && signalingState === 'idle') {
          // Receive offer, send answer
          await createPeerConnection(false);
          await peerConnection.setRemoteDescription(new RTCSessionDescription({
            type: 'offer',
            sdp: data.sdp
          }));

          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);

          addMsg('Received offer, sending answer...', 'status');
          updateStatus('Sending answer...', false);
          signalingState = 'waiting_for_answer';

          showQrForData(JSON.stringify({
            type: 'answer',
            peerId: peerId,
            sdp: answer.sdp
          }));

          closeModal('qrRecvModal');

        } else if (data.type === 'answer' && signalingState === 'waiting_for_answer') {
          // Receive answer
          await peerConnection.setRemoteDescription(new RTCSessionDescription({
            type: 'answer',
            sdp: data.sdp
          }));

          addMsg('Received answer, establishing connection...', 'status');
          closeModal('qrRecvModal');

        } else {
          alert('Invalid state for this message type');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text || !dataChannel || dataChannel.readyState !== 'open') return;

      dataChannel.send(text);
      addMsg(text, 'sent');
      msgInput.value = '';
    }

    function disconnect() {
      if (dataChannel) dataChannel.close();
      if (peerConnection) peerConnection.close();
      dataChannel = null;
      peerConnection = null;
      signalingState = 'idle';
      localOffer = null;
      updateStatus('Disconnected', false);
      sendBtn.disabled = true;
      msgInput.disabled = true;
      qrSendBtn.disabled = true;
      qrRecvBtn.disabled = true;
      initBtn.disabled = false;
      disconnectBtn.disabled = true;
      addMsg('Disconnected', 'status');
    }

    window.startCamera = async function() {
      try {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
          scanningActive = false;
          document.getElementById('cameraFeed').style.display = 'none';
          document.getElementById('cameraBtn').textContent = 'Use Camera';
          return;
        }

        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        const video = document.getElementById('cameraFeed');
        video.srcObject = cameraStream;
        video.style.display = 'block';
        video.play();

        scanningActive = true;
        document.getElementById('cameraBtn').textContent = 'Stop Camera';

        const codeReader = new ZXing.BrowserQRCodeReader();
        const result = await codeReader.decodeFromVideoElement(video);
        
        if (result) {
          document.getElementById('pasteInput').value = result.text;
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
          scanningActive = false;
          video.style.display = 'none';
          document.getElementById('cameraBtn').textContent = 'Use Camera';
          addMsg('QR code scanned!', 'status');
        }
      } catch (err) {
        console.error('Camera error:', err);
        alert('Camera access denied or not available');
      }
    };

    initBtn.addEventListener('click', initiate);
    qrSendBtn.addEventListener('click', () => {
      document.getElementById('qrSendModal').classList.add('show');
    });
    qrRecvBtn.addEventListener('click', () => {
      document.getElementById('qrRecvModal').classList.add('show');
      document.getElementById('pasteInput').value = '';
    });
    disconnectBtn.addEventListener('click', disconnect);
    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    window.addEventListener('load', () => {
      addMsg('Your ID: ' + peerId, 'status');
      addMsg('Click "Start" to initiate connection', 'status');
      updateStatus('Ready', false);
    });
  </script>
</body>
</html>
