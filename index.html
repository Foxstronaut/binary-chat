<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluetooth P2P Chat</title>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    body { display: flex; align-items: center; justify-content: center; padding: 20px; }
    .container { width: 100%; max-width: 500px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: 100vh; max-height: 600px; }
    header { background: #2196F3; color: white; padding: 20px; text-align: center; }
    h1 { margin: 0 0 5px 0; font-size: 24px; }
    .subtitle { font-size: 12px; opacity: 0.9; margin: 0; }
    .status { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #ccc; }
    .status-dot.connected { background: #4CAF50; }
    .status-dot.scanning { background: #FF9800; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .status-text { font-size: 13px; color: #666; }
    .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
    .msg { padding: 10px 12px; border-radius: 8px; font-size: 14px; word-wrap: break-word; max-width: 90%; }
    .msg.sent { background: #E8F5E9; color: #1B5E20; align-self: flex-end; }
    .msg.recv { background: #E3F2FD; color: #0D47A1; align-self: flex-start; }
    .msg.status { background: #FFF9C4; color: #F57F17; font-size: 12px; align-self: center; }
    .input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 8px; }
    input { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    button { padding: 10px 16px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
    button:hover { background: #1976D2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .controls { padding: 15px 20px; border-top: 1px solid #eee; display: flex; gap: 8px; }
    .alert { padding: 10px 15px; margin: 10px 15px 0; border-radius: 6px; font-size: 12px; }
    .alert.error { background: #ffebee; color: #d32f2f; }
    .alert.success { background: #e8f5e9; color: #388e3c; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Bluetooth Chat</h1>
      <p class="subtitle">P2P messaging between devices</p>
    </header>

    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <div class="status-text" id="statusText">Ready</div>
    </div>

    <div id="alerts"></div>

    <div class="messages" id="messages"></div>

    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Type message..." />
      <button id="sendBtn" disabled>Send</button>
    </div>

    <div class="controls">
      <button id="scanBtn">Scan</button>
      <button id="connectBtn" disabled>Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
  </div>

  <script>
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const scanBtn = document.getElementById('scanBtn');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const alerts = document.getElementById('alerts');

    let device = null;
    let server = null;
    let service = null;
    let txChar = null;
    let rxChar = null;

    function updateStatus(text, state) {
      statusText.textContent = text;
      statusDot.className = 'status-dot ' + state;
    }

    function showAlert(msg, type = 'error') {
      const alert = document.createElement('div');
      alert.className = 'alert ' + type;
      alert.textContent = msg;
      alerts.appendChild(alert);
      setTimeout(() => alert.remove(), 4000);
    }

    function addMsg(text, type) {
      const m = document.createElement('div');
      m.className = 'msg ' + type;
      m.textContent = text;
      messagesDiv.appendChild(m);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function scan() {
      if (!navigator.bluetooth) {
        showAlert('Web Bluetooth not supported');
        return;
      }

      updateStatus('Scanning...', 'scanning');
      scanBtn.disabled = true;

      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['0000180a-0000-1000-8000-00805f9b34fb', 'generic_access']
        });

        showAlert(`Found: ${device.name || 'Unknown'}`, 'success');
        connectBtn.disabled = false;
        addMsg('Device found: ' + (device.name || 'Unknown'), 'status');

      } catch (e) {
        if (e.name !== 'NotFoundError') {
          showAlert('Scan error: ' + e.message);
        }
        updateStatus('Ready', '');
      }
      scanBtn.disabled = false;
    }

    async function connect() {
      if (!device) {
        showAlert('No device selected');
        return;
      }

      try {
        updateStatus('Connecting...', 'scanning');
        connectBtn.disabled = true;

        server = await device.gatt.connect();
        const services = await server.getPrimaryServices();
        
        if (services.length === 0) {
          showAlert('No GATT services found');
          return;
        }

        service = services[0];
        const chars = await service.getCharacteristics();
        
        if (chars.length === 0) {
          showAlert('No characteristics found');
          return;
        }

        txChar = chars[0];
        if (chars.length > 1) rxChar = chars[1];

        if (rxChar) {
          rxChar.addEventListener('characteristicvaluechanged', onMsgReceived);
          try {
            await rxChar.startNotifications();
          } catch (e) {
            console.log('Notifications not supported');
          }
        }

        updateStatus('Connected', 'connected');
        disconnectBtn.disabled = false;
        scanBtn.disabled = true;
        sendBtn.disabled = false;
        msgInput.disabled = false;

        showAlert('Connected!', 'success');
        addMsg('Connected', 'status');

      } catch (e) {
        showAlert('Connection error: ' + e.message);
        updateStatus('Ready', '');
        connectBtn.disabled = false;
      }
    }

    function onMsgReceived(e) {
      const data = e.target.value;
      const text = new TextDecoder().decode(data.buffer);
      addMsg(text, 'recv');
    }

    async function send() {
      const text = msgInput.value.trim();
      if (!text || !txChar) return;

      try {
        const data = new TextEncoder().encode(text);
        await txChar.writeValue(data);
        addMsg(text, 'sent');
        msgInput.value = '';
      } catch (e) {
        showAlert('Send error: ' + e.message);
      }
    }

    async function disconnect() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
      }
      updateStatus('Ready', '');
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      scanBtn.disabled = false;
      sendBtn.disabled = true;
      msgInput.disabled = true;
      addMsg('Disconnected', 'status');
    }

    scanBtn.addEventListener('click', scan);
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    sendBtn.addEventListener('click', send);
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') send();
    });

    window.addEventListener('load', () => {
      if (!navigator.bluetooth) {
        showAlert('Web Bluetooth API not supported on this device');
      }
      addMsg('Press Scan to find Bluetooth devices', 'status');
    });
  </script>
</body>
</html>
